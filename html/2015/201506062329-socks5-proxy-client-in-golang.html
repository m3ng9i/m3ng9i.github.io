<!DOCTYPE HTML>
<html lang='zh-cn'>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,width=device-width">
    <meta name="author" content="m3ng9i">
    <meta name="title" content="使用 Golang 通过 Proxy 抓取网页">
    <meta name="pubtime" content="2015-06-06T23:29:00+08:00">
    <meta name="url" content="http://mengqi.info/html/2015/201506062329-socks5-proxy-client-in-golang.html">
    <script type="text/javascript" src="/static/libs/html5shiv.min.js"></script>
    <script type="text/javascript" src="/static/libs/jquery-1.11.2.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/libs/normalize.css">
    <link rel="stylesheet" type="text/css" href="/static/include/style.css">
    <link rel="alternate" type="application/atom+xml" title="My Candy 最新文章" href="/feed.xml">
    <title>使用 Golang 通过 Proxy 抓取网页 - My Candy</title>
</head>

<body>
    <div id="container">
        <div id="container_inner">
            <article>
                <header>
                    <h1 class="title"><a href="http://mengqi.info/html/2015/201506062329-socks5-proxy-client-in-golang.html">使用 Golang 通过 Proxy 抓取网页</a></h1>
                    <p class="pubtime">m3ng9i 发表于 <time datetime="2015-06-06T23:29:00+08:00" pubdate>2015-06-06 23:29</time></p>
                </header>
                <p>使用 Go 自带的 <code>http</code> 包可以很方便的抓取网页，例如下面这个例子：</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;
import &quot;net/http&quot;
import &quot;io/ioutil&quot;

func main() {
    resp, err := http.Get(&quot;http://mengqi.info&quot;)
    if err != nil {
        fmt.Println(err)
    } else {

        b, err := ioutil.ReadAll(resp.Body)
        resp.Body.Close()
        if err != nil {
            fmt.Println(err)
        } else {
            fmt.Println(string(b))
        }
    }
}
</code></pre>

<p>但是如果想要通过代理服务器抓取网页该怎么办呢？我们可以尝试下 <a href="https://godoc.org/golang.org/x/net/proxy" rel="nofollow">golang.org/x/net/proxy</a> 这个包。由于这个包并不在 Go 的标准库中，需要使用 <code>go get</code> 命令进行安装。</p>

<p>下面是利用 proxy 包创建 socks5 proxy client 并抓取网页的例子。</p>

<p>首先需要创建一个 <em>dialer</em>，它包含了 sock5 代理服务器的地址、用户名、密码。<a href="http://golang.org/pkg/net/#Dialer" rel="nofollow">net 包文档</a>提到：</p>

<blockquote>
<p>A Dialer contains options for connecting to an address.</p>
</blockquote>

<p>下面是创建 dialer 的代码，这里假设代理服务器的 IP 为 127.0.0.1，端口为 8080，用户名为 username, 密码为 password：</p>

<pre><code class="language-go">dialer, err := proxy.SOCKS5(&quot;tcp&quot;, &quot;127.0.0.1:8080&quot;,
    &amp;proxy.Auth{User:&quot;username&quot;, Password:&quot;password&quot;},
    &amp;net.Dialer {
        Timeout: 30 * time.Second,
        KeepAlive: 30 * time.Second,
    },
)
</code></pre>

<p>如果代理服务器并不需要用户名、密码，可以将 proxy.SOCKS5 函数的第三个参数设置为 <code>nil</code>。</p>

<p>接下来需要创建一个 <em>transport</em>，它会利用刚才创建的 dialer 进行 TCP 连接。<a href="http://golang.org/pkg/net/http/#pkg-overview" rel="nofollow">net/http 包文档</a>提到：</p>

<blockquote>
<p>For control over proxies, TLS configuration, keep-alives, compression, and other settings, create a Transport.</p>
</blockquote>

<p>创建 transport 的代码：</p>

<pre><code class="language-go">transport := &amp;http.Transport{
    Proxy: nil,
    Dial: dialer.Dial,
    TLSHandshakeTimeout: 10 * time.Second,
}
</code></pre>

<p>现在，创建一个 <em>http client</em>，它会用到刚才创建的 transport：</p>

<pre><code class="language-go">client := &amp;http.Client { Transport: transport }
</code></pre>

<p>有了 http client，就可以通过代理服务器发起 http 请求了：</p>

<pre><code class="language-go">response, err := client.Get(&quot;http://mengqi.info&quot;)
</code></pre>

<p>下面是完整的例子代码，client 的创建过程被封装成了一个函数：</p>

<pre><code class="language-go">package main

import &quot;fmt&quot;
import &quot;net&quot;
import &quot;time&quot;
import &quot;os&quot;
import &quot;net/http&quot;
import &quot;io/ioutil&quot;
import &quot;golang.org/x/net/proxy&quot;


func Socks5Client(addr string, auth ...*proxy.Auth) (client *http.Client, err error) {

    dialer, err := proxy.SOCKS5(&quot;tcp&quot;, addr,
        nil,
        &amp;net.Dialer {
            Timeout: 30 * time.Second,
            KeepAlive: 30 * time.Second,
        },
    )
    if err != nil {
        return
    }

    transport := &amp;http.Transport{
        Proxy: nil,
        Dial: dialer.Dial,
        TLSHandshakeTimeout: 10 * time.Second,
    }

    client = &amp;http.Client { Transport: transport }

    return
}


func main() {

    client, err := Socks5Client(&quot;127.0.0.1:8080&quot;)
    if err != nil {
        fmt.Println(err)
        os.Exit(1)
    }

    // ip138 可以显示请求客户端的 IP
    resp, err := client.Get(&quot;http://1111.ip138.com/ic.asp&quot;)
    if err != nil {
        fmt.Println(err)
        os.Exit(1)
    }

    b, err := ioutil.ReadAll(resp.Body)
    resp.Body.Close()
    if err != nil {
        fmt.Println(err)
    } else {
        fmt.Println(string(b))
    }

}
</code></pre>

            </article>

            <nav>
                <p><a href="/">首页</a> <a href="/html/about.html">关于</a> <a href="/feed.xml" title="atom 1.0 feed">订阅</a></p>
            </nav>
        </div>
    </div>

    <div class="hidden">
        <script async type="text/javascript" src="http://tajs.qq.com/stats?sId=42968888" charset="UTF-8"></script>
        <script async type="text/javascript" src="http://s95.cnzz.com/z_stat.php?id=1255242145&web_id=1255242145"></script>
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-63483419-1', 'auto');
            ga('send', 'pageview');
        </script>
    </div>
</body>

</html>
